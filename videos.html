<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Videos - LearnNest</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="videos.css">
</head>
<body>
    <nav class="nav">
        <a href="home.html">Home</a>
        <a href="grades.html">Grades</a>
        <a href="subjects.html">Subjects</a>
        <a href="videos.html" class="active">Videos</a>
        <a href="books.html">Books</a>
        <a href="about.html">About</a>
    </nav>

    <main class="container">
        <h1 id="page-title">Videos</h1>
        <p id="subtitle" class="muted"></p>

        <section id="videos-list">
            <!-- dynamic video items will be inserted here -->
        </section>

        <p id="no-videos" class="muted hidden">No videos found for this subject yet.</p>
    </main>

    <script>
        function capitalizeWords(str) {
            return str ? str.replace(/-/g, ' ').split(' ').map(s => s.charAt(0).toUpperCase() + s.slice(1)).join(' ') : '';
        }

        const params = new URLSearchParams(window.location.search);
        const grade = params.get('grade');
        const subject = params.get('subject');

        const pageTitle = document.getElementById('page-title');
        const subtitle = document.getElementById('subtitle');
        const videosList = document.getElementById('videos-list');
        const noVideos = document.getElementById('no-videos');

        // Add body classes so CSS can target subject and grade
        (function addBodyClasses() {
            const body = document.body;
            if (subject) body.classList.add('subject-' + normalizeKey(subject));
            if (grade) body.classList.add('grade-' + normalizeKey(grade));
        })();

        // normalize subject to match keys in data file
        function normalizeKey(s) {
            return s ? s.toLowerCase().trim().replace(/\s+/g, '-').replace(/[^a-z0-9\-]/g, '') : '';
        }

        // Extract a YouTube ID from many common URL formats
        function extractYouTubeId(url) {
            if (!url) return null;
            const patterns = [
                /(?:youtube\.com\/watch\?v=)([\w-]+)/i,
                /(?:youtube\.com\/embed\/)([\w-]+)/i,
                /(?:youtu\.be\/)([\w-]+)/i,
                /(?:youtube\.com\/v\/)([\w-]+)/i
            ];
            for (const p of patterns) {
                const m = url.match(p);
                if (m && m[1]) return m[1];
            }
            return null;
        }

        function renderItems(items) {
            videosList.innerHTML = '';
            if (!items || items.length === 0) {
                noVideos.classList.remove('hidden');
                return;
            }
            noVideos.classList.add('hidden');
            items.forEach(v => {
                const el = document.createElement('div');
                el.className = 'video-item';
                const title = v.title || '';
                const youtubeId = v.youtubeId || extractYouTubeId(v.url);
                const hasYouTube = !!youtubeId;

                if (hasYouTube) {
                    const thumb = `https://i.ytimg.com/vi/${youtubeId}/hqdefault.jpg`;
                    el.innerHTML = `
                        <h3>${title}</h3>
                        <div class="meta">${v.description || ''}</div>
                        <div class="video-thumb" data-id="${youtubeId}" role="button" tabindex="0">
                            <img src="${thumb}" alt="${title}">
                            <div class="play-overlay">â–¶</div>
                        </div>
                    `;
                    videosList.appendChild(el);

                    const thumbEl = el.querySelector('.video-thumb');
                    thumbEl.addEventListener('click', () => {
                        const id = thumbEl.dataset.id;
                        const player = document.createElement('div');
                        player.className = 'video-player';
                        player.innerHTML = `<iframe src="https://www.youtube.com/embed/${id}?rel=0&showinfo=0" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
                        thumbEl.replaceWith(player);
                    });
                    thumbEl.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') thumbEl.click(); });
                } else {
                    const safeUrl = v.url ? v.url : '#';
                    el.innerHTML = `<h3>${title}</h3><a href="${safeUrl}" target="_blank" rel="noopener">Watch</a>`;
                    videosList.appendChild(el);
                }
            });
        }

        if (subject) {
            pageTitle.textContent = `${capitalizeWords(subject)} Videos`;
            subtitle.textContent = grade ? `Grade ${grade}` : '';

            const key = normalizeKey(subject);

            // Load videos data from JSON
            fetch('videos.json')
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.json();
                })
                .then(data => {
                    // data[key] can be either:
                    // - an object with grade keys, e.g. { "7": [...], "8": [...], "all": [...] }
                    // - or an array (legacy), e.g. [ ... ]
                    const subjectData = data[key];
                    let items = [];
                    if (!subjectData) {
                        items = [];
                    } else if (Array.isArray(subjectData)) {
                        // legacy flat list: use it for all grades
                        items = subjectData;
                    } else if (typeof subjectData === 'object') {
                        // prefer exact grade match, then 'all', then any array inside object
                        if (grade && Array.isArray(subjectData[grade])) {
                            items = subjectData[grade];
                        } else if (Array.isArray(subjectData['all'])) {
                            items = subjectData['all'];
                        } else {
                            // fallback: find first array value in the object
                            const firstArray = Object.values(subjectData).find(v => Array.isArray(v));
                            items = firstArray || [];
                        }
                    }
                    renderItems(items);
                })
                .catch(err => {
                    console.error('Failed to load videos.json', err);
                    // Fallback: show no videos message
                    renderItems([]);
                });
        } else {
            pageTitle.textContent = 'All Videos';
            subtitle.textContent = '';
            noVideos.classList.remove('hidden');
        }
    </script>
</body>
</html>